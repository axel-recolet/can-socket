#!/bin/bash

# Script de migration complÃ¨te vers l'API TypeScript
# Ce script remplace l'API JavaScript legacy par l'API gÃ©nÃ©rÃ©e depuis TypeScript

set -e

echo "ðŸš€ Migration vers l'API TypeScript..."

# 1. Sauvegarder les fichiers JS legacy
echo "ðŸ“¦ Sauvegarde des fichiers JavaScript legacy..."
mkdir -p legacy/js
cp *.js legacy/js/ 2>/dev/null || echo "Aucun fichier JS Ã  sauvegarder Ã  la racine"

# 2. Construire l'API TypeScript
echo "ðŸ”¨ Construction de l'API TypeScript..."
npm run build-all

# 3. VÃ©rifier que les fichiers de sortie existent
if [ ! -f "dist/src/main.js" ]; then
    echo "âŒ Erreur: dist/src/main.js n'existe pas aprÃ¨s la construction"
    exit 1
fi

# 4. CrÃ©er des liens symboliques vers l'API gÃ©nÃ©rÃ©e (optionnel)
echo "ðŸ”— CrÃ©ation de liens vers l'API gÃ©nÃ©rÃ©e..."

# CrÃ©er un nouveau index.js qui rÃ©fÃ¨re Ã  l'API compilÃ©e
cat > index.js << 'EOF'
/**
 * SocketCAN Neon Rust - JavaScript API
 * 
 * This file is automatically generated from TypeScript sources.
 * Do not edit this file directly - edit the TypeScript sources in src/ instead.
 * 
 * To regenerate this API: npm run generate-js
 */

// Forward to the compiled TypeScript API
module.exports = require('./dist/src/main.js');
EOF

# 5. CrÃ©er un wrapper pour exemple.js si nÃ©cessaire
if [ -f "legacy/js/exemple.js" ]; then
    echo "ðŸ“ CrÃ©ation du wrapper pour exemple.js..."
    cat > exemple.js << 'EOF'
/**
 * Example usage - forwarded to TypeScript-compiled version
 * 
 * This file forwards to the compiled TypeScript example.
 * For development, use: npm run example-dev
 */

// Forward to the compiled TypeScript example
require('./dist/src/exemple.js');
EOF
fi

# 6. Validation
echo "âœ… Validation de l'API..."
node -e "
const SocketCAN = require('./index.js');
console.log('âœ“ SocketCAN class imported successfully');
console.log('âœ“ Version:', require('./package.json').version);
console.log('âœ“ Main entry point:', require('./package.json').main);
"

echo ""
echo "ðŸŽ‰ Migration terminÃ©e avec succÃ¨s !"
echo ""
echo "ðŸ“‹ RÃ©sumÃ©:"
echo "  â€¢ Fichiers JavaScript legacy sauvegardÃ©s dans legacy/js/"
echo "  â€¢ API JavaScript gÃ©nÃ©rÃ©e depuis TypeScript dans dist/src/"
echo "  â€¢ Point d'entrÃ©e principal: dist/src/main.js"
echo "  â€¢ Wrapper de compatibilitÃ©: index.js"
echo ""
echo "ðŸ”§ Commandes utiles:"
echo "  â€¢ npm run generate-js    - RÃ©gÃ©nÃ©rer l'API JavaScript"
echo "  â€¢ npm run test           - Tester avec l'API gÃ©nÃ©rÃ©e"
echo "  â€¢ npm run example        - ExÃ©cuter l'exemple compilÃ©"
echo "  â€¢ npm run dev            - Mode dÃ©veloppement"
echo ""
